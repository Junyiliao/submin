#!/usr/bin/python

import os
import sys
import time
import signal
import subprocess
import errno
os.environ['SUBMIN_ENV'] = '/var/lib/submin'
from submin.models import storage, options

storage.open()
os.environ['SUBMIN_ALIAS'] = options.value('base_url_submin')
storage.close()

from wsgiref import simple_server
from submin.dispatch.wsgi_app import application
 
class NoLogHandler(simple_server.WSGIRequestHandler):
    def log_message(self, *args):
        pass

def run():
	httpd = simple_server.WSGIServer(('',8000), NoLogHandler)
	httpd.set_app(application)
	httpd.serve_forever()

def run_autoreload():
	programname = os.path.abspath(sys.argv[0])
	while True:
		new_time = old_time = os.path.getmtime(programname)
		print 'starting WSGI server'
		while True:
			try:
				child = subprocess.Popen(sys.argv[0:1])
			except OSError, e:
				if e.errno == errno.ETXTBSY:
					pass	
			else:
				break
		try:
			while new_time == old_time:
				time.sleep(1)
				try:
					new_time = os.path.getmtime(programname)
				except OSError:
					print "Could not stat file %s" % programname
					pass

		except KeyboardInterrupt:
			return
		finally:
			if child:
				child.terminate()

if '--auto-reload' in sys.argv:
	print 'starting auto-reload server'
	run_autoreload()
else:
	run()
